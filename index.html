<!--Hello-->

<!DOCTYPE html>
<html>
<head>
    <title>News Map</title>
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<body>
    <script src="map.js"></script>
    <script src="keys.js"></script>
    <!--Leaflet JavaScript-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        
        // Title at the top of the page
        // Create a container div for the text
        var textContainer = document.createElement("div");
        textContainer.style.textAlign = "center";

        // Styling of the text
        var textDiv = document.createElement("div");
        textDiv.style.fontSize = "50px";
        textDiv.style.fontFamily = "Arial, sans-serif";
        textDiv.style.color = "red";
        textDiv.textContent = "News Map";
        textContainer.style.position = "relative";
        textContainer.style.top = "5.5px";

        // Append the text div to the text container and the body
        textContainer.appendChild(textDiv);
        document.body.appendChild(textContainer);
    </script>

    <!-- Create a div element to hold the map -->
    <div id="map" style="width: 95%; height: 88vh; top: 20px; margin: 0 auto; position: relative;"></div>

    <script>
        // Initialize the map
        let map = L.map('map', {
            center: [48.2082, 16.3738],
            zoom: 5,
            minZoom: 2,
            maxZoom: 16
        });

        // Add a tile layer (in this case, OpenStreetMap tiles)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let longitudeData, latitudeData, locationData

        function geocodeLocation(location) {
            let counter=0;
            let la;
            let lo;
            let worked=false;
            while (counter<countryCoords.length){
                let x =(countryCoords[counter].alpha2)
                if(x.toUpperCase()===(location.toUpperCase())){
                    la=countryCoords[counter].latitude;
                    lo=countryCoords[counter].longitude
                    worked = true;
                    break;
                }
                else{
                    counter++;
                }
            }
            if (worked){
                return {la, lo};
            }
            else{
                console.log("No coorinates found for "+location);
            }
        }

        geocodeLocation("china")
        //Function to fetch and display news articles for a location
        async function fetchNewsData(location) {
            key = api_keys[num]
            language = "en";
            rawdate = subtractOneMonthFromDate(new Date());
            date = rawdate.toISOString().substr(0, 10);
            let newsUrl = `https://api.worldnewsapi.com/search-news?api-key=${key}&source-countries=${location}&language=${language}&earliest-publish-date=${date}`;
            let w = 0;
            while(true){
                try {
                    const response = await fetch(newsUrl);
                    if (!response.ok) {
                        throw new Error('Error fetching news API KEY IS DEAD :(');
                        changeNum();
                        falseVar();
                    }
                    const data = await response.json();
                    if (data.news == null) {
                        changeNum();
                        falseVar();
                    }
                    return data.news;
                    break;
                } catch (error) {
                    console.error('Error fetching news data: ', error);
                    changeNum();
                    falseVar();
                }
                w++;
                if(w>100){
                    break;
                }
            }
        }

        async function displayArticles(code) {
            let coords = await geocodeLocation(code);

            const articles = await fetchNewsData(code);
            articles.forEach(function (article) {
                // Create a marker
                let marker = L.marker([coords.la, coords.lo], {
                    icon: L.AwesomeMarkers.icon({
                        icon: 'circle',
                        markerColor: 'red',
                        prefix: 'fa',
                        iconColor: 'black'
                    }),
                }).addTo(map);

                marker.bindPopup(`
                    <h3>${article.title}</h3>
                    ${article.description && article.description.length > 15 ? `<p>${article.description}</p>` : ''}
                    <a href="${article.url}" target="_blank">Read more</a>
                `);
            });
        }
        function displayPins(code) {
            let coords = geocodeLocation(code);
            let q;
            for (let z = 0; z < countryCoords.length; z++) {
                if ((countryCoords[z].alpha2).toUpperCase() === (code.toUpperCase())) {
                    q = countryCoords[z].country;
                    break;
                }
            }
            let marker = L.marker([coords.la, coords.lo], {
                icon: L.AwesomeMarkers.icon({
                    icon: 'circle',
                    markerColor: 'red',
                    prefix: 'fa',
                    iconColor: 'black'
                }),
            }).addTo(map);

            // Attach a click event handler to the marker
            marker.on('click', function () {
                // Make an API request to fetch news data for the selected country
                fetchNewsData(code)
                    .then((newsData) => {
                        // Check if news data is available
                        if (newsData && newsData.length > 0) {
                            // Display the news data in a popup
                            marker.bindPopup(`
                                <h3>${q}</h3>
                                <div>
                                    <h4>Latest News:</h4>
                                    <ul>
                                        ${newsData
                                            .filter(article => article.title.length >= 30)
                                            .map(article => `<li><a href="${article.url}" target="_blank">${article.title}</a></li>`)
                                            .join('')}
                                    </ul>
                                </div>
                            `);
                        } else {
                            // No news available
                            marker.bindPopup(`
                                <h3>${q}</h3>
                                <p>No news available</p>
                            `);
                        }
                        marker.openPopup();
                    })
                    .catch((error) => {
                        // Handle errors by displaying a message
                        console.error("Error fetching news data:", error);
                        marker.bindPopup(`
                            <h3>${q}</h3>
                            <p>No news available</p>
                        `);
                        marker.openPopup();
                    });
            });
        }
        function fillMap(){
            let i = 0;
            while (i<countryCodes.length){
                variable = true;
                displayPins(countryCodes[i]);
                //displayArticles(countryCodes[i]);

                i++
            }
        }
        fillMap();
    </script>
</body>
</html>
